<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Usage Dashboard</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Alpine.js via CDN -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div x-data="usageDashboard()" x-cloak class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-white mb-2">LLM Usage Dashboard</h1>
                    <p class="text-gray-400">Real-time usage statistics across all providers</p>
                </div>
                <div class="flex items-center gap-4">
                    <!-- Auto-refresh toggle -->
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" x-model="autoRefresh" class="w-4 h-4 rounded">
                        <span class="text-sm text-gray-400">Auto-refresh</span>
                    </label>
                    <!-- Refresh button -->
                    <button @click="refresh()"
                            :disabled="loading"
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-700 rounded-lg transition-colors flex items-center gap-2">
                        <svg x-show="!loading" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        <svg x-show="loading" class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>Refresh</span>
                    </button>
                </div>
            </div>
            <!-- Provider filters -->
            <div class="mt-4 flex items-center gap-2 flex-wrap">
                <span class="text-sm text-gray-400">Filter:</span>
                <button @click="toggleProvider('all')"
                        :class="selectedProviders.includes('all') ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'"
                        class="px-3 py-1 rounded-full text-sm transition-colors">
                    All
                </button>
                <template x-for="provider in availableProviders" :key="provider.id">
                    <button @click="toggleProvider(provider.id)"
                            :class="selectedProviders.includes(provider.id) ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'"
                            class="px-3 py-1 rounded-full text-sm transition-colors"
                            x-text="provider.name">
                    </button>
                </template>
            </div>
        </header>

        <!-- Error state -->
        <div x-show="error" x-transition class="mb-6 bg-red-900/50 border border-red-700 rounded-lg p-4">
            <p class="text-red-300">
                <svg class="w-5 h-5 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                </svg>
                <span x-text="error"></span>
            </p>
        </div>

        <!-- Loading state -->
        <div x-show="loading && !stats" class="flex items-center justify-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
        </div>

        <!-- Stats grid -->
        <div x-show="!loading || stats" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <template x-for="provider in filteredStats" :key="provider.provider">
                <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 hover:border-gray-600 transition-colors">
                    <!-- Provider header -->
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h2 class="text-xl font-semibold text-white" x-text="getProviderName(provider.provider)"></h2>
                            <p x-show="provider.extra?.account" class="text-sm text-gray-400" x-text="'Account: ' + provider.extra?.account"></p>
                        </div>
                        <div :class="getUtilizationClass(provider)"
                             class="w-12 h-12 rounded-full flex items-center justify-center text-lg font-bold"
                             x-text="getMaxUtilization(provider) + '%'">
                        </div>
                    </div>

                    <!-- Error state for provider -->
                    <div x-show="provider.error" class="text-red-400 text-sm bg-red-900/30 rounded-lg p-3">
                        <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                        </svg>
                        <span x-text="provider.error?.message || 'Error fetching usage'"></span>
                    </div>

                    <!-- Usage windows -->
                    <div x-show="!provider.error && provider.windows && provider.windows.length > 0" class="space-y-4">
                        <template x-for="window in provider.windows" :key="window.label">
                            <div class="space-y-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium text-gray-300" x-text="window.label"></span>
                                    <span class="text-sm text-gray-400" x-text="formatUtilization(window.utilization)"></span>
                                </div>
                                <!-- Progress bar -->
                                <div class="w-full bg-gray-700 rounded-full h-2.5 overflow-hidden">
                                    <div :class="getUtilizationClass({windows: [window]})"
                                         class="h-2.5 rounded-full transition-all duration-500"
                                         :style="'width: ' + Math.min(window.utilization, 100) + '%'"></div>
                                </div>
                                <!-- Reset time -->
                                <div x-show="window.resets_at" class="flex justify-between text-xs text-gray-500">
                                    <span>Resets:</span>
                                    <span x-text="formatResetTime(window.resets_at)"></span>
                                </div>
                                <!-- Token details if available -->
                                <div x-show="window.used !== undefined && window.limit !== undefined"
                                     class="flex justify-between text-xs text-gray-500">
                                    <span x-text="formatTokens(window.used) + ' used'"></span>
                                    <span x-text="formatTokens(window.limit) + ' limit'"></span>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Extra usage (for Claude) -->
                    <div x-show="provider.extra?.extra_usage" class="mt-4 pt-4 border-t border-gray-700">
                        <p class="text-sm font-medium text-gray-300 mb-2">Extra Usage Credits</p>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-400">Usage</span>
                                <span class="text-sm text-gray-300" x-text="formatUtilization(provider.extra.extra_usage.utilization)"></span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-2 overflow-hidden">
                                <div :class="getUtilizationClass({windows: [{utilization: provider.extra.extra_usage.utilization}]})"
                                     class="h-2 rounded-full transition-all duration-500"
                                     :style="'width: ' + Math.min(provider.extra.extra_usage.utilization, 100) + '%'"></div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500">
                                <span x-text="'$' + provider.extra.extra_usage.used_credits.toFixed(2)"></span>
                                <span x-text="'of $' + provider.extra.extra_usage.monthly_limit.toFixed(2)"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <!-- Empty state -->
        <div x-show="!loading && filteredStats.length === 0 && !error"
             class="text-center py-20 bg-gray-800 rounded-xl border border-gray-700">
            <svg class="w-16 h-16 mx-auto text-gray-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <p class="text-gray-400">No providers configured.</p>
            <p class="text-gray-500 text-sm mt-2">Run <code class="bg-gray-700 px-2 py-1 rounded">llm-usage setup</code> to add providers.</p>
        </div>

        <!-- Last updated -->
        <div x-show="lastUpdated" class="mt-8 text-center text-sm text-gray-500">
            Last updated: <span x-text="lastUpdated"></span>
        </div>
    </div>

    <script>
        function usageDashboard() {
            return {
                stats: null,
                loading: false,
                error: null,
                autoRefresh: true,
                refreshInterval: null,
                lastUpdated: null,
                selectedProviders: ['all'],
                availableProviders: [],

                init() {
                    this.loadProviders();
                    this.refresh();

                    // Watch for auto-refresh changes
                    this.$watch('autoRefresh', value => {
                        if (value) {
                            this.refreshInterval = setInterval(() => this.refresh(), 30000);
                        } else {
                            clearInterval(this.refreshInterval);
                        }
                    });

                    // Start auto-refresh if enabled
                    if (this.autoRefresh) {
                        this.refreshInterval = setInterval(() => this.refresh(), 30000);
                    }
                },

                async loadProviders() {
                    try {
                        const response = await fetch('/api/v1/providers');
                        if (response.ok) {
                            this.availableProviders = await response.json();
                        }
                    } catch (e) {
                        console.error('Failed to load providers:', e);
                    }
                },

                async refresh() {
                    this.loading = true;
                    this.error = null;

                    try {
                        const params = new URLSearchParams();
                        if (!this.selectedProviders.includes('all')) {
                            params.set('provider', this.selectedProviders.join(','));
                        }

                        const response = await fetch('/api/v1/usage?' + params.toString());
                        if (!response.ok) {
                            throw new Error('Failed to fetch usage data');
                        }

                        this.stats = await response.json();
                        this.lastUpdated = new Date().toLocaleTimeString();
                    } catch (e) {
                        this.error = e.message;
                    } finally {
                        this.loading = false;
                    }
                },

                get filteredStats() {
                    if (!this.stats?.providers) return [];
                    return this.stats.providers;
                },

                getProviderName(id) {
                    const names = {
                        'claude': 'Claude',
                        'kimi': 'Kimi',
                        'zai': 'Z.AI'
                    };
                    return names[id] || id.toUpperCase();
                },

                getMaxUtilization(provider) {
                    if (!provider.windows || provider.windows.length === 0) return 0;
                    return Math.round(Math.max(...provider.windows.map(w => w.utilization || 0)));
                },

                getUtilizationClass(provider) {
                    const max = this.getMaxUtilization(provider);
                    if (max >= 90) return 'bg-red-500';
                    if (max >= 75) return 'bg-yellow-500';
                    return 'bg-green-500';
                },

                formatUtilization(value) {
                    return (value || 0).toFixed(1) + '%';
                },

                formatResetTime(isoString) {
                    const now = new Date();
                    const reset = new Date(isoString);
                    const diff = reset - now;

                    if (diff < 0) return 'Expired';

                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

                    if (days > 0) return 'in ' + days + 'd ' + hours + 'h';
                    if (hours > 0) return 'in ' + hours + 'h ' + minutes + 'm';
                    return 'in ' + minutes + 'm';
                },

                formatTokens(value) {
                    if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
                    if (value >= 1000) return (value / 1000).toFixed(1) + 'K';
                    return value.toString();
                },

                toggleProvider(providerId) {
                    if (providerId === 'all') {
                        this.selectedProviders = ['all'];
                    } else {
                        this.selectedProviders = this.selectedProviders.filter(p => p !== 'all');
                        const index = this.selectedProviders.indexOf(providerId);
                        if (index > -1) {
                            this.selectedProviders.splice(index, 1);
                        } else {
                            this.selectedProviders.push(providerId);
                        }
                        if (this.selectedProviders.length === 0) {
                            this.selectedProviders = ['all'];
                        }
                    }
                    this.refresh();
                }
            };
        }
    </script>
</body>
</html>
